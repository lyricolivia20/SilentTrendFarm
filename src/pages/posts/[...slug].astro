---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const posts = await getCollection('posts');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post, allPosts: posts },
	}));
}

const { post, allPosts } = Astro.props;
const { Content, remarkPluginFrontmatter } = await post.render();

// Calculate reading time (rough estimate: 200 words per minute)
const wordCount = post.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

const categoryLabels = {
	'indie-dev': 'The Indie Dev\'s Playbook',
	'ai-ml': 'ML Diaries',
	'it-tech': 'Troubleshoot.exe',
};

const categoryColors = {
	'indie-dev': 'emerald',
	'ai-ml': 'cyan',
	'it-tech': 'violet',
};

const category = post.data.category || 'indie-dev';
const categoryLabel = categoryLabels[category];
const accentColor = categoryColors[category];

// Contextual tool recommendations based on category and tags
const toolRecommendations = {
	'indie-dev': [
		{ name: 'Unity Pro', description: 'Industry-standard game engine', url: '/tools#game-engines' },
		{ name: 'Blender Courses', description: 'Master 3D modeling for free', url: '/tools#3d-modeling' },
		{ name: 'GitHub Copilot', description: 'AI-powered code completion', url: '/tools#dev-tools' },
		{ name: 'Udemy', description: 'Affordable game dev courses', url: '/tools#learning' },
	],
	'ai-ml': [
		{ name: 'RunPod', description: 'Cloud GPUs for ML training', url: '/tools#cloud-gpu' },
		{ name: 'Hugging Face', description: 'Essential NLP toolkit', url: '/tools#ai-apis' },
		{ name: 'Google Colab Pro', description: 'Accessible GPU resources', url: '/tools#cloud-gpu' },
		{ name: 'Replicate API', description: 'AI art without infrastructure', url: '/tools#ai-apis' },
	],
	'it-tech': [
		{ name: 'DigitalOcean', description: 'Developer-friendly cloud', url: '/tools#hosting' },
		{ name: 'Raspberry Pi Kits', description: 'DIY electronics projects', url: '/tools#diy-tech' },
		{ name: 'High-Res Monitors', description: 'Essential for productivity', url: '/tools#peripherals' },
		{ name: 'NVMe SSDs', description: 'Fast storage upgrades', url: '/tools#computing' },
	],
};

const recommendations = toolRecommendations[category] || toolRecommendations['indie-dev'];

// Get related posts (same category, excluding current)
const relatedPosts = allPosts
	.filter(p => p.data.category === category && p.slug !== post.slug)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3);

// Format date
const formattedDate = post.data.pubDate.toLocaleDateString('en-US', {
	year: 'numeric',
	month: 'long',
	day: 'numeric'
});
---

<Layout title={`${post.data.title} ‚Äî Digital Polymath`} description={post.data.description}>
	<article class="max-w-3xl mx-auto">
		<!-- Breadcrumb -->
		<nav class="mb-6">
			<a href={`/#${category}`} class={`text-sm font-mono text-${accentColor}-400 hover:text-${accentColor}-300 transition-colors`}>
				‚Üê {categoryLabel}
			</a>
		</nav>

		<header class="mb-10 pb-8 border-b border-zinc-800" transition:name={`post-${post.slug}`}>
			{post.data.tags && post.data.tags.length > 0 && (
				<div class="flex flex-wrap gap-2 mb-4">
					{post.data.tags.slice(0, 4).map((tag) => (
						<span class={`text-xs px-2.5 py-1 bg-${accentColor}-500/10 text-${accentColor}-400 rounded font-mono border border-${accentColor}-500/20`}>{tag}</span>
					))}
				</div>
			)}
			<h1 class="text-3xl md:text-4xl font-bold text-zinc-100 leading-tight mb-4 font-display">{post.data.title}</h1>
			<p class="text-lg text-zinc-400 leading-relaxed mb-4">{post.data.description}</p>
			
			<!-- Meta info -->
			<div class="flex flex-wrap items-center gap-4 text-sm text-zinc-500 font-mono">
				<time datetime={post.data.pubDate.toISOString()}>
					{formattedDate}
				</time>
				<span class="text-zinc-700">‚Ä¢</span>
				<span>{readingTime} min read</span>
				<span class="text-zinc-700">‚Ä¢</span>
				<span>{wordCount.toLocaleString()} words</span>
			</div>
		</header>

		<div class="prose">
			<Content />
		</div>

		<!-- Recommended Tools Callout -->
		<aside class={`mt-12 p-6 rounded-xl border border-${accentColor}-500/20 bg-${accentColor}-500/5`}>
			<div class="flex items-center gap-2 mb-4">
				<span class="text-xl">üõ†</span>
				<h3 class="font-bold text-zinc-100 font-display">Recommended Tools</h3>
			</div>
			<p class="text-zinc-400 text-sm mb-4">Level up your workflow with these tools mentioned in or related to this article:</p>
			<div class="grid sm:grid-cols-2 gap-3">
				{recommendations.map((tool) => (
					<a href={tool.url} class={`group flex items-center gap-3 p-3 rounded-lg border border-zinc-800/50 bg-zinc-900/50 hover:border-${accentColor}-500/30 transition-all`}>
						<div class="flex-1">
							<div class={`font-medium text-zinc-200 group-hover:text-${accentColor}-400 transition-colors text-sm`}>{tool.name}</div>
							<div class="text-zinc-500 text-xs">{tool.description}</div>
						</div>
						<svg class="w-4 h-4 text-zinc-600 group-hover:text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
						</svg>
					</a>
				))}
			</div>
			<div class="mt-4 pt-4 border-t border-zinc-800/50">
				<a href="/tools" class={`text-sm font-mono text-${accentColor}-400 hover:text-${accentColor}-300 transition-colors`}>
					Browse all tools ‚Üí
				</a>
			</div>
		</aside>

		<!-- Related Posts -->
		{relatedPosts.length > 0 && (
			<aside class="mt-16 pt-8 border-t border-zinc-800">
				<h3 class="text-lg font-bold text-zinc-100 font-display mb-6">More from {categoryLabel}</h3>
				<div class="grid gap-4">
					{relatedPosts.map((related) => (
						<a href={`/posts/${related.slug}/`} class={`group block p-4 rounded-xl border border-zinc-800/50 bg-zinc-900/30 hover:border-${accentColor}-500/30 hover:bg-${accentColor}-500/5 transition-all`}>
							<h4 class={`font-semibold text-zinc-100 group-hover:text-${accentColor}-400 transition-colors mb-1`}>{related.data.title}</h4>
							<p class="text-zinc-500 text-sm line-clamp-2">{related.data.description}</p>
						</a>
					))}
				</div>
			</aside>
		)}

		<!-- Back to section -->
		<footer class="mt-12 pt-8 border-t border-zinc-800">
			<a href={`/#${category}`} class={`inline-flex items-center gap-2 text-sm font-mono text-zinc-400 hover:text-${accentColor}-400 transition-colors`}>
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
				</svg>
				Back to {categoryLabel}
			</a>
		</footer>
	</article>
</Layout>
